<script setup>
import { MwRow, MwCol } from "@/lib/mediawiki.ui";
import { getAutonym, getDir } from "@wikimedia/language-data";
import SxSectionSelectorSectionList from "./SXSectionSelectorSectionList.vue";
import sadRobotSVG from "../../assets/sad-robot.svg?raw";
import { computed } from "vue";
import { CdxButton, CdxInfoChip } from "@wikimedia/codex";
import useCurrentSectionSuggestion from "@/composables/useCurrentSectionSuggestion";
import { isEasySectionTranslation } from "@/utils/translationDifficulty";
import useURLHandler from "@/composables/useURLHandler";

const { sectionSuggestion: suggestion } = useCurrentSectionSuggestion();
const { targetLanguageURLParameter: targetLanguage } = useURLHandler();

defineEmits(["select-section", "close"]);

const targetLanguageAutonym = computed(() => getAutonym(targetLanguage.value));
const noMissingSectionExists = computed(
  () => Object.keys(suggestion.value?.missingSections || {}).length === 0
);

const orderedMissingSections = computed(() => {
  if (!suggestion.value?.orderedMissingSections) {
    return [];
  }

  return suggestion.value.orderedMissingSections.map((section) => ({
    ...section,
    isEasy: isEasySectionTranslation(
      suggestion.value.getSectionSize(section.sourceTitle)
    ),
  }));
});
</script>

<template>
  <section class="sx-section-selector__missing-sections py-2">
    <h4
      v-i18n:cx-sx-section-selector-missing-sections-title="[
        targetLanguageAutonym,
      ]"
      class="sx-section-selector__list-title mb-0 pb-0 py-3 px-4"
    />
    <sx-section-selector-section-list
      v-if="!noMissingSectionExists"
      :sections="orderedMissingSections"
      @select-section="$emit('select-section', $event)"
    >
      <template #default="{ sourceSection, isEasy }">
        <!-- eslint-disable vue/no-v-html -->
        <h5
          class="ma-0"
          :lang="suggestion?.sourceLanguage"
          :dir="getDir(suggestion?.sourceLanguage)"
          v-html="sourceSection"
        />
        <!-- eslint-enable vue/no-v-html -->
        <cdx-info-chip
          v-if="isEasy"
          v-i18n:cx-sx-section-selector-easy-section-badge
          class="sx-section-selector__easy-section-badge"
        />
      </template>
    </sx-section-selector-section-list>
    <mw-row
      v-else
      class="sx-section-selector__empty-missing-sections px-4 my-0"
    >
      <!--eslint-disable vue/no-v-text-v-html-on-component vue/no-v-html -->
      <mw-col class="py-6 justify-center" v-html="sadRobotSVG" />
      <!--eslint-enable vue/no-v-text-v-html-on-component -->
      <mw-col
        cols="12"
        class="sx-section-selector__empty-missing-sections-details pa-0"
      >
        <h6 v-i18n:cx-sx-section-selector-empty-missing-sections-title />
      </mw-col>
      <mw-col
        cols="12"
        class="sx-section-selector__empty-missing-sections-details pa-0 mb-2"
      >
        <p v-i18n:cx-sx-section-selector-empty-missing-sections-desc />
      </mw-col>
      <mw-col cols="12" class="pa-0 mb-2">
        <cdx-button
          weight="quiet"
          action="progressive"
          class="px-0"
          @click="$emit('close')"
        >
          {{
            $i18n("cx-sx-section-selector-pick-other-translation-button-label")
          }}
        </cdx-button>
      </mw-col>
    </mw-row>
  </section>
</template>

<style lang="less">
@import (reference) "~@wikimedia/codex-design-tokens/theme-wikimedia-ui.less";

.sx-section-selector__empty-missing-sections {
  &-details {
    h6 {
      color: @color-subtle;
      font-weight: @font-weight-bold;
    }
  }
}

.cdx-info-chip {
  &.sx-section-selector__easy-section-badge {
    border: 0;
    background-color: @background-color-success-subtle;
    font-size: @font-size-small;
    font-weight: @font-weight-normal;
  }
}
</style>
